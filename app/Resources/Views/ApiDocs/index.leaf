<!DOCTYPE html>
<html>
<head>
    <title>API Documentation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            color: #333;
            background-color: #fafafa;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .api-section {
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            background-color: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .api-header {
            background-color: #f8f9fa;
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }
        .api-header:hover {
            background-color: #f0f0f0;
        }
        .api-header-content {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
        .method {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
            color: white;
            min-width: 60px;
            text-align: center;
            font-size: 14px;
            margin-right: 10px;
        }
        .GET {
            background-color: #61affe;
        }
        .POST {
            background-color: #49cc90;
        }
        .PUT {
            background-color: #fca130;
        }
        .DELETE {
            background-color: #f93e3e;
        }
        .PATCH {
            background-color: #50e3c2;
        }
        .path {
            font-family: monospace;
            font-size: 16px;
            margin-right: 10px;
        }
        .GET-path { color: #61affe; }
        .POST-path { color: #49cc90; }
        .PUT-path { color: #fca130; }
        .DELETE-path { color: #f93e3e; }
        .PATCH-path { color: #50e3c2; }
        .api-actions {
            display: flex;
            align-items: center;
        }
        .api-content {
            padding: 0;
            background-color: white;
            border-top: 1px solid #eee;
            display: none;
        }
        .api-content-inner {
            padding: 20px;
        }
        .section-title {
            margin-top: 20px;
            color: #3b4151;
            font-size: 16px;
            font-weight: bold;
        }
        .code-block {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre;
            margin: 15px 0;
            font-size: 14px;
            color: #333;
        }
        .toggle-arrow {
            display: inline-block;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 5px 5px 0 5px;
            border-color: #666 transparent transparent transparent;
            margin-left: 10px;
            transition: transform 0.2s;
            vertical-align: middle;
        }
        .api-section.open .toggle-arrow {
            transform: rotate(180deg);
        }
        .api-section.open .api-content {
            display: block;
        }
        .edit-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .edit-btn:hover {
            background-color: #2980b9;
        }
        .action-btn {
            padding: 5px 10px;
            margin-left: 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
        }
        .edit-action {
            background: #6c757d;
            color: white;
        }
        .delete-action {
            background: #f93e3e;
            color: white;
            display: flex;
            align-items: center;
        }
        .delete-action .toggle-arrow {
            margin-left: 5px;
            border-width: 4px 4px 0 4px;
        }
        .category-filter {
            margin: 20px 0;
        }
        .category-filter select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: white;
        }
        .base-url {
            font-family: monospace;
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
            padding: 0 15px;
        }
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 800px;
            border-radius: 5px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-group textarea {
            min-height: 100px;
        }
        .form-actions {
            text-align: right;
            margin-top: 20px;
        }
        .form-actions button {
            padding: 8px 16px;
            margin-left: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .save-btn {
            background-color: #28a745;
            color: white;
        }
        .cancel-btn {
            background-color: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="edit-btn" onclick="openModal()">+ Добавить описание API</button>
        
        <h1>Описание API (App Kudo)</h1>
        
        <div class="category-filter">
            <label for="categorySelect">Фильтровать по типу данных:</label>
            <select id="categorySelect" onchange="filterByCategory()">
                <option value="">Все типы</option>
                #for(category in categories):
                    <option value="#(category)">#(category)</option>
                #endfor
            </select>
        </div>
        
        #if(apis.isEmpty):
            <p>No API documentation available. Click "Add API" to get started.</p>
        #else:
            #for(api in apis):
                <div class="api-section" data-category="#(api.category)" id="api-#(api.id)">
                    <div class="api-header" onclick="toggleApiSection('#(api.id)')">
                        <div class="api-header-content">
                            <span class="method #(api.method)">#(api.method)</span>
                            <span class="path #(api.method)-path">{Base URL}#(api.endpoint)</span>
                            <span class="name #(api.name)">#(api.name)</span>
                        </div>
                        <div class="api-actions">
                            <button class="action-btn edit-action" onclick="event.stopPropagation(); editApi('#(api.id)')">Редактировать</button>
                            <button class="action-btn delete-action" onclick="event.stopPropagation(); deleteApi('#(api.id)')">
                                Удалить
                                <span class="toggle-arrow"></span>
                            </button>
                        </div>
                    </div>
                    <div class="api-content">
                        <div class="api-content-inner">
                            
                            #if(!api.description.isEmpty):
                                <h4 class="section-title">Description</h4>
                                #(api.description)
                            #endif

                            #if(!api.baseURL.isEmpty):
                                <h4 class="section-title">Base URL</h4>
                                #(api.baseURL)
                            #endif


                            #if(!api.headers.isEmpty):
                                <h4 class="section-title">Headers</h4>
                                <div class="code-block">
                                    #(api.headers)
                                </div>
                            #endif
                            
                            #if(!api.pathParameters.isEmpty):
                                <h4 class="section-title">Path Parameters</h4>
                                <div class="code-block">
                                    #(api.pathParameters)
                                </div>
                            #endif
                            
                            #if(!api.queryParameters.isEmpty):
                                <h4 class="section-title">Query Parameters</h4>
                                <div class="code-block">
                                    #(api.queryParameters)
                                </div>
                            #endif
                            
                            #if(!api.requestExample.isEmpty):
                                <h4 class="section-title">Request Example</h4>
                                <div class="code-block">
                                    #(api.requestExample)
                                </div>
                            #endif
                            
                            #if(!api.responseExample.isEmpty):
                                <h4 class="section-title">Response Example</h4>
                                <div class="code-block">
                                    #(api.responseExample)
                                </div>
                            #endif
                        </div>
                    </div>
                </div>
            #endfor
        #endif
    </div>
    
    <div id="apiModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Добавить новое описание API</h2>
            <form id="apiForm">
                <input type="hidden" id="apiId">
                
                <div class="form-group">
                    <label for="name">API Name:</label>
                    <input type="text" id="name" required>
                </div>
                
                <div class="form-group">
                    <label for="category">Category:</label>
                    <input type="text" id="category" required>
                </div>
                
                <div class="form-group">
                    <label for="baseURL">Base URL:</label>
                    <input type="text" id="baseURL" required>
                </div>
                
                <div class="form-group">
                    <label for="endpoint">Endpoint:</label>
                    <input type="text" id="endpoint" required>
                </div>
                
                <div class="form-group">
                    <label for="method">HTTP Method:</label>
                    <select id="method" required>
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                        <option value="PATCH">PATCH</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="description">Description:</label>
                    <textarea id="description" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="headers">Headers (JSON format):</label>
                    <textarea id="headers"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="pathParameters">Path Parameters (JSON format):</label>
                    <textarea id="pathParameters"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="queryParameters">Query Parameters (JSON format):</label>
                    <textarea id="queryParameters"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="requestExample">Request Example (JSON format):</label>
                    <textarea id="requestExample"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="responseExample">Response Example (JSON format):</label>
                    <textarea id="responseExample"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="cancel-btn" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="save-btn">Save</button>
                </div>
            </form>
        </div>
    </div>
    <script>

        function toggleApiSection(apiId) {
            const section = document.getElementById(`api-${apiId}`);
            section.classList.toggle('open');
        }
        
        function openModal() {
            document.getElementById('apiModal').style.display = 'block';
            document.getElementById('modalTitle').innerText = 'Добавить новое описание API';
            document.getElementById('apiForm').reset();
            document.getElementById('apiId').value = '';
        }
        
        function closeModal() {
            document.getElementById('apiModal').style.display = 'none';
        }
        
        function filterByCategory() {
            const category = document.getElementById('categorySelect').value;
            const apiSections = document.querySelectorAll('.api-section');
            
            apiSections.forEach(section => {
                if (category === '' || section.getAttribute('data-category') === category) {
                    section.style.display = 'block';
                } else {
                    section.style.display = 'none';
                }
            });
        }
        
        async function editApi(apiId) {
            try {
                const response = await fetch(`/api_data/apiID/${apiId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const api = await response.json();
                document.getElementById('modalTitle').innerText = 'Редактировать API';
                document.getElementById('apiId').value = api['id'];
                document.getElementById('name').value = api['name'] || '';
                document.getElementById('category').value = api['category'] || '';
                document.getElementById('baseURL').value = api.baseURL || '';
                document.getElementById('endpoint').value = api.endpoint || '';
                document.getElementById('method').value = api.method || 'GET';
                document.getElementById('description').value = api.description || '';
                document.getElementById('headers').value = api.headers || '';
                document.getElementById('pathParameters').value = api.pathParameters || '';
                document.getElementById('queryParameters').value = api.queryParameters || '';
                document.getElementById('requestExample').value = api.requestExample || '';
                document.getElementById('responseExample').value = api.responseExample || '';
                
                document.getElementById('apiModal').style.display = 'block';
            } catch (error) {
                console.error('Error fetching API:', error);
                alert('Failed to fetch API details. Please check console for details.');
            }
        }
        
        async function deleteApi(apiId) {
            if (confirm('Are you sure you want to delete this API?')) {
                try {
                    const response = await fetch(`/api_data/${apiId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Failed to delete API');
                    }
                } catch (error) {
                    console.error('Error deleting API:', error);
                    alert('Failed to delete API');
                }
            }
        }
        
        document.getElementById('apiForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const apiId = document.getElementById('apiId').value;
            const url = apiId ? `/api_data/${apiId}` : '/api_data';
            const method = apiId ? 'PUT' : 'POST';
            
            const apiData = {
                name: document.getElementById('name').value,
                category: document.getElementById('category').value,
                baseURL: document.getElementById('baseURL').value,
                endpoint: document.getElementById('endpoint').value,
                method: document.getElementById('method').value,
                description: document.getElementById('description').value,
                headers:            "\n" + document.getElementById('headers').value,
                pathParameters:     "\n" + document.getElementById('pathParameters').value,
                queryParameters:    "\n" + document.getElementById('queryParameters').value,
                requestExample:     "\n" + document.getElementById('requestExample').value,
                responseExample:    "\n" + document.getElementById('responseExample').value
            };
            
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(apiData)
                });
                
                if (response.ok) {
                    window.location.reload();
                } else {
                    const error = await response.json();
                    alert(`Failed to save API: ${error.reason || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error saving API:', error);
                alert('Failed to save API');
            }
        });
        
        window.onclick = function(event) {
            const modal = document.getElementById('apiModal');
            if (event.target === modal) {
                closeModal();
            }
        };
    </script>
</body>
</html>